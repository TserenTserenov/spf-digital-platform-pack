---
id: DP.FM.002
name: Смешение слоёв
type: failure-mode
status: draft
summary: "Смешение слоёв архитектуры платформы: код в Pack, знания в Downstream, UI в архитектуре"
created: 2026-02-10
trust:
  F: 3
  G: domain
  R: 0.5
epistemic_stage: emerging
related:
  violates: [DP.D.010]
  applies_to: [DP.ARCH.001]
---

# FM: Смешение архитектурных слоёв

## 1. Паттерн ошибки

Логика одного архитектурного слоя (или зоны) размещается в другом, нарушая принцип слабой связанности 3-слойной архитектуры платформы (DP.ARCH.001).

## 2. Почему это ошибка

3-слойная архитектура (Интерфейсы → Обработка [ИИ + Детерминированные] → Данные) существует для обеспечения эволюционируемости. Смешение слоёв или зон:

1. **Блокирует эволюцию** — замена компонента одного слоя тянет за собой изменения в другом
2. **Нарушает масштабируемость** — невозможно подключить нового пользователя без изменения логики
3. **Создаёт хрупкость** — изменение в одном месте ломает непредсказуемые другие места
4. **Мешает отчуждаемости** — смешанные слои невозможно передать другому пользователю

## 3. Варианты смешения

### 3.1. Бизнес-логика в интерфейсе (Слой 3 → Слой 2)

| Симптом | Пример |
|---------|--------|
| Telegram-бот содержит логику FSM | `bot.py` проверяет состояние ученика и решает следующий шаг |
| Интерфейс форматирует данные | HTML-шаблон содержит вычисления |
| Клиент хранит состояние | Telegram-бот помнит контекст диалога |

**Правильно:** Бот — тонкий клиент. Отправляет запрос → получает готовый ответ от обработки (слой 2).

### 3.2. Интерфейс обращается к данным (Слой 3 → Слой 1)

| Симптом | Пример |
|---------|--------|
| Бот читает из БД напрямую | Telegram-бот делает SELECT |
| Фронтенд хранит данные | localStorage как основное хранилище |

**Правильно:** Интерфейс общается только со слоем обработки (слой 2) — с любой зоной.

### 3.3. Смешение зон внутри слоя обработки (Зона А ↔ Зона Б)

| Симптом | Пример |
|---------|--------|
| ИИ-система содержит детерминированную логику | Промпт вычисляет баллы по формуле |
| Сервис содержит LLM-вызовы | MCP-сервер внутри вызывает Claude |
| ИИ-система знает схему данных | Промпт описывает таблицы и поля |

**Правильно:** Детерминированная логика — в зоне Б (сервисы, MCP). LLM-зависимая логика — в зоне А (ИИ-системы). Граница: нужен ли LLM для этой функции? ИИ-система работает с данными предпочтительно через MCP (зона Б), который абстрагирует хранилище.

## 4. Тест обнаружения

**Для каждого компонента задать вопрос:**

1. **Тест замены:** Можно ли заменить этот компонент, не трогая другие слои/зоны?
   - Нет → слои или зоны смешаны

2. **Тест LLM:** Нужен ли LLM для работы этого компонента?
   - Да → должен быть в слое 2, зона А (ИИ-системы)
   - Нет → слой 2, зона Б (сервисы) или слой 1 (данные)

3. **Тест пользователя:** Видит ли пользователь этот компонент?
   - Да → должен быть в слое 3 (интерфейсы)
   - Нет → внутренний слой (1 или 2)

4. **Тест данных:** Знает ли компонент, где и как хранятся данные?
   - Да → должен быть в слое 1 (данные) или слое 2, зона Б (сервис-обёртка)
   - Нет → слой 2 зона А или слой 3 (работает через абстракции)

## 5. Антипаттерн → Паттерн

| Антипаттерн | Паттерн |
|-------------|---------|
| Бот проверяет подписку | Бот → API подписок (Сервис) → ответ |
| Промпт содержит `INSERT INTO` | Промпт → MCP tool `save_data` → Сервис → БД |
| Telegram-бот рендерит Markdown | Бот получает готовый текст от ИИ-системы |
| MCP-сервер вызывает Claude внутри | MCP-сервер возвращает данные, Claude обрабатывает |

## 6. Профилактика

1. **IPO-контракт** — каждый компонент описан через Входы-Обработка-Выходы, связи явные
2. **MCP как граница** — ИИ-системы работают только через MCP-инструменты
3. **Тонкий клиент** — интерфейсы не содержат логику, только ввод/вывод
4. **Код-ревью** — проверка: не пересекает ли компонент границу слоя?

## 7. Связанные документы

- [DP.ARCH.001 Архитектура](../02-domain-entities/DP.ARCH.001-platform-architecture.md) — 3-слойная модель
- [DP.D.010 Характеристика ≠ Принцип](../01-domain-contract/01B-distinctions.md) — слабая связанность (принцип) обеспечивает эволюционируемость (характеристика)
- [DP.FM.001 Информация как знание](DP.FM.001-information-as-knowledge.md) — другая структурная ошибка
