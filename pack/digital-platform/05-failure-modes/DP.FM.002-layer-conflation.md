---
id: DP.FM.002
type: failure-mode
status: draft
created: 2026-02-10
trust:
  F: 3
  G: domain
  R: 0.5
epistemic_stage: emerging
---

# FM: Смешение архитектурных слоёв

## 1. Паттерн ошибки

Логика одного архитектурного слоя размещается в другом слое, нарушая принцип слабой связанности 4-слойной архитектуры платформы (DP.ARCH.001).

## 2. Почему это ошибка

4-слойная архитектура (Интерфейсы → ИИ-системы → Сервисы+MCP → Хранилище) существует для обеспечения эволюционируемости. Смешение слоёв:

1. **Блокирует эволюцию** — замена компонента одного слоя тянет за собой изменения в другом
2. **Нарушает масштабируемость** — невозможно подключить нового пользователя без изменения логики
3. **Создаёт хрупкость** — изменение в одном месте ломает непредсказуемые другие места
4. **Мешает отчуждаемости** — смешанные слои невозможно передать другому пользователю

## 3. Варианты смешения

### 3.1. Бизнес-логика в интерфейсе (Слой 4 → Слой 3)

| Симптом | Пример |
|---------|--------|
| Telegram-бот содержит логику FSM | `bot.py` проверяет состояние ученика и решает следующий шаг |
| Интерфейс форматирует данные | HTML-шаблон содержит вычисления |
| Клиент хранит состояние | Telegram-бот помнит контекст диалога |

**Правильно:** Бот — тонкий клиент. Отправляет запрос → получает готовый ответ от ИИ-системы (Слой 3).

### 3.2. Работа с хранилищем из ИИ-системы (Слой 3 → Слой 1)

| Симптом | Пример |
|---------|--------|
| ИИ-система напрямую обращается к БД | Промпт содержит SQL-запросы |
| ИИ-система знает схему данных | Промпт описывает таблицы и поля |
| ИИ-система управляет файлами | Claude Code читает/пишет файлы без MCP |

**Правильно:** ИИ-система работает через MCP-серверы (Слой 2), которые абстрагируют хранилище.

### 3.3. Интерфейс обращается к хранилищу (Слой 4 → Слой 1)

| Симптом | Пример |
|---------|--------|
| Бот читает из БД напрямую | Telegram-бот делает SELECT |
| Фронтенд хранит данные | localStorage как основное хранилище |

**Правильно:** Интерфейс общается только со Слоем 3 (ИИ-системы) или Слоем 2 (API сервисов).

### 3.4. Смешение ИИ-системы и сервиса (Слой 3 ↔ Слой 2)

| Симптом | Пример |
|---------|--------|
| ИИ-система содержит детерминированную логику | Промпт вычисляет баллы по формуле |
| Сервис содержит LLM-вызовы | MCP-сервер внутри вызывает Claude |

**Правильно:** Детерминированная логика — в сервисах (Слой 2). LLM-зависимая логика — в ИИ-системах (Слой 3). Граница: нужен ли LLM для этой функции?

## 4. Тест обнаружения

**Для каждого компонента задать вопрос:**

1. **Тест замены:** Можно ли заменить этот компонент, не трогая другие слои?
   - Нет → слои смешаны

2. **Тест LLM:** Нужен ли LLM для работы этого компонента?
   - Да → должен быть в Слое 3 (ИИ-системы)
   - Нет → должен быть в Слое 2 (Сервисы) или Слое 1 (Хранилище)

3. **Тест пользователя:** Видит ли пользователь этот компонент?
   - Да → должен быть в Слое 4 (Интерфейсы)
   - Нет → внутренний слой (1, 2 или 3)

4. **Тест данных:** Знает ли компонент, где и как хранятся данные?
   - Да → должен быть в Слое 1 (Хранилище) или Слое 2 (Сервис-обёртка)
   - Нет → Слой 3 или 4 (работает через абстракции)

## 5. Антипаттерн → Паттерн

| Антипаттерн | Паттерн |
|-------------|---------|
| Бот проверяет подписку | Бот → API подписок (Сервис) → ответ |
| Промпт содержит `INSERT INTO` | Промпт → MCP tool `save_data` → Сервис → БД |
| Telegram-бот рендерит Markdown | Бот получает готовый текст от ИИ-системы |
| MCP-сервер вызывает Claude внутри | MCP-сервер возвращает данные, Claude обрабатывает |

## 6. Профилактика

1. **IPO-контракт** — каждый компонент описан через Входы-Обработка-Выходы, связи явные
2. **MCP как граница** — ИИ-системы работают только через MCP-инструменты
3. **Тонкий клиент** — интерфейсы не содержат логику, только ввод/вывод
4. **Код-ревью** — проверка: не пересекает ли компонент границу слоя?

## 7. Связанные документы

- [DP.ARCH.001 Архитектура](../02-domain-entities/DP.ARCH.001-platform-architecture.md) — 4-слойная модель
- [DP.D.010 Характеристика ≠ Принцип](../01-domain-contract/01B-distinctions.md) — слабая связанность (принцип) обеспечивает эволюционируемость (характеристика)
- [DP.FM.001 Информация как знание](DP.FM.001-information-as-knowledge.md) — другая структурная ошибка
